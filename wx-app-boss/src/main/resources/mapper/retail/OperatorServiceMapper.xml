<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 运营商业务战报 -->
<mapper namespace="com.phone.erp.boss.mapper.retail.OperatorServiceMapper">
<!-- sql查询条件 -->
    <sql id="queryCondition">
      WHERE T.GROUP_ID = #{groupId}
        <if test="null!=startDate">
            AND t.BILLS_DATE &gt;= to_date(#{startDate},'YYYY-MM-DD')
        </if>
        <if test="null!=endDate">
            AND t.BILLS_DATE &lt;= to_date(#{endDate},'YYYY-MM-DD')
        </if>
        <if test="null!=keyWord">
            <if test="groupField=='sectionName'">AND(UPPER(TS.NAME) LIKE UPPER('%${keyWord}%')OR UPPER(TS.CODE) LIKE UPPER('%${keyWord}%'))</if>
            <if test="groupField=='salesManName'">AND(UPPER(TE.NAME) LIKE UPPER('%${keyWord}%')OR UPPER(TE.CODE) LIKE UPPER('%${keyWord}%'))</if>
            <if test="groupField=='businessName'">AND(UPPER(TCU.NAME) LIKE UPPER('%${keyWord}%')OR UPPER(TCU.CODE) LIKE UPPER('%${keyWord}%'))</if>
            <if test="groupField=='operatorName'">AND(UPPER(TP3.CONTENT_1) LIKE UPPER('%${keyWord}%'))</if>
        </if>
        <if test="null!=operatorId">
            AND TP3.ID = #{operatorId}
        </if>
        <if test="null!=operatorUnitId">
            AND TCU.ID = #{operatorUnitId}
        </if>
        <if test="null!=operatorNameId">
            AND TBA.ID = #{operatorNameId}
        </if>

        AND T.COMPANY_ID IN(${companyIds})
        AND T.SECTION_ID IN(${sectionIds})
    </sql>
    <sql id="commonFields">
        <if test="groupField=='sectionName'">SECTIONID AS ID,SECTIONCODE AS CODE,SECTIONNAME AS NAME</if>
        <if test="groupField=='salesManName'">SALESMANID AS ID,SALESMAMCODE AS CODE,SALESMANNAME AS NAME</if>
        <if test="groupField=='businessName'">BUSINESSID AS ID,BUSINESSCODE AS CODE,BUSINESSNAME AS NAME,OPERATORUNITID,OPERATORUNITNAME</if>
        <if test="groupField=='operatorName'">OPERATORID AS ID,OPERATORCODE AS CODE,OPERATORNAME AS NAME</if>
    </sql>
    <!-- 汇总字段 -->
    <sql id="groups">
        <if test="groupField=='sectionName'">ID,CODE,NAME</if>
        <if test="groupField=='salesManName'">ID,CODE,NAME</if>
        <if test="groupField=='businessName'">ID,CODE,NAME,OPERATORUNITID,OPERATORUNITNAME</if>
        <if test="groupField=='operatorName'">ID,CODE,NAME</if>
    </sql>

    <!-- 核心sql片段 -->
    <sql id="codeSqlAndQueryCondition">
            SELECT
                TS.ID   AS SECTIONID,
                TS.CODE AS SECTIONCODE,
                TS.NAME AS SECTIONNAME,
                TE.ID   AS SALESMANID,
                TE.CODE AS SALESMAMCODE,
                TE.NAME AS SALESMANNAME,
                TCU.ID  AS OPERATORUNITID,
                TCU.NAME AS OPERATORUNITNAME,
                TBA.ID   AS BUSINESSID,
                TBA.BIZ_CODE AS BUSINESSCODE,
                TBA.BIZ_NAME AS BUSINESSNAME,
                TP3.ID AS OPERATORID,
                TP3.CODE AS OPERATORCODE,
                TP3.CONTENT_1 AS OPERATORNAME,
                DECODE(T.BILLS_TYPE, 46, -IRB.QTY, IRB.QTY) AS GOODSQUANTITY,
                IRB.BUS_AMOUNT AS ACTUALRECEIVABLES,
                IRB.COMMISSION_WILL AS COMMISSIONESTIMATE
              FROM I_RETAIL T
                JOIN T_COMPANY TC ON T.COMPANY_ID = TC.ID
                JOIN T_SECTION TS ON T.SECTION_ID = TS.ID
                JOIN I_RETAIL_BUS IRB ON IRB.RETAIL_ID = T.ID
                JOIN T_BUSINESS_ARCH TBA ON IRB.BUS_ID = TBA.ID
                JOIN T_EMPLOYEE TE ON IRB.SALESMAN1 = TE.ID
                LEFT JOIN T_CONTACT_UNIT TCU ON TBA.CONTACTSUNIT_ID = TCU.ID
                LEFT JOIN (SELECT DECODE(P.CODE, '2', -2, '3', -3, -4) ID, P.CODE, P.CONTENT_1 FROM T_PUBLICTABS P WHERE P.TYPE_CODE = 'YYS') TP3 ON TBA.OPERATOR_CODE = TP3.CODE
                <include refid="queryCondition"/>
    </sql>

        <!-- 运营商业务战报获取主页分页集合 -->
        <select id="getPageData" resultType="com.phone.erp.boss.vo.retail.OperatorServiceVo">
            SELECT <include refid="groups"/>,SUM(GOODSQUANTITY)AS GOODSQUANTITY
            <if test="canSeeAmount==1">  ,
                TO_CHAR(SUM(ACTUALRECEIVABLES))AS ACTUALRECEIVABLES,
                TO_CHAR(SUM(COMMISSIONESTIMATE))AS COMMISSIONESTIMATE,
                TO_CHAR(ROUND(JXC_ALL_PCK.CHECK_DIVIDE(SUM(COMMISSIONESTIMATE), SUM(GOODSQUANTITY)),2))AS COMMISSIONAVG
            </if>
            FROM(
            SELECT <include refid="commonFields"/>,GOODSQUANTITY,ACTUALRECEIVABLES,COMMISSIONESTIMATE
            FROM (
            <include refid="codeSqlAndQueryCondition"/>
            )
            )
            GROUP BY <include refid="groups"/>
            ORDER BY <include refid="groups"/>
        </select>
        <!-- 运营商业务战报获取主页总计行对象 -->
        <select id="getTotalVo" resultType="com.phone.erp.boss.vo.retail.OperatorServiceVo" >
            SELECT SUM(GOODSQUANTITY)AS GOODSQUANTITY,
                    SUM(ACTUALRECEIVABLES) AS ACTUALRECEIVABLES,
                    SUM(COMMISSIONESTIMATE) AS COMMISSIONESTIMATE,
                    ROUND(JXC_ALL_PCK.CHECK_DIVIDE(SUM(COMMISSIONESTIMATE),SUM(GOODSQUANTITY))*100,2) AS COMMISSIONAVG
                  FROM (
                      <include refid="codeSqlAndQueryCondition"/>
                  )
        </select>
</mapper>